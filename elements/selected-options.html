<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../polymer/lib/elements/dom-if.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../paper-input/paper-input-container.html">
<link rel="import" href="../../paper-input/paper-input-error.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">

<link rel="import" href="../mixins/list-item-utils-mixin.html">

<dom-module id="esmm-selected-options">
  <template>
    <style>
      *[hidden] {
        display: none !important;
      }

      iron-icon {
        @apply --esmm-icons;
      }

      .selected-item {
        display: inline-block;
        width: auto;
        height: auto;
        margin-right: 8px;
        line-height: 24px;
      }

      :host([readonly]) .selected-item {
        margin-right: 0;
      }

      .selected-item-body {
        @apply --layout-horizontal;
        @apply --layout-wrap;
        @apply --layout-center;
      }

      :host([readonly]) .selected-item paper-icon-button,
      :host([readonly]) .selected-item:last-of-type .readonly-separator {
        display: none;
      }

      #selected-items-wrapper {
        width: 100%;
      }

      .readonly-separator {
        display: inline-block;
        padding: 0 5px;
        margin: 0;
      }

      .selected-item paper-icon-button {
        color: var(--error-color);
        padding: 0;
        height: 18px;
        width: 18px;
        margin-top: -2px;
      }

    </style>

    <paper-input-container id="container"
                           no-label-float="[[noLabelFloat]]"
                           always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]"
                           auto-validate$="[[autoValidate]]"
                           disabled$="[[disabled]]"
                           invalid="[[invalid]]">

      <label hidden$="[[!label]]" aria-hidden="true" for="input" slot="label">[[label]]</label>

      <div slot="input" class="paper-input-input">
        <span class="placeholder"
              hidden$="[[_hidePlaceholder]]">
          [[placeholder]]
        </span>
        <div id="selected-items-wrapper"
             hidden$="[[!_hidePlaceholder]]">

          <template is="dom-repeat"
                    notify-dom-change
                    on-dom-change="_selectedItemsDisplayHasChanged"
                    items="[[selectedItems]]">
            <span class="selected-item">
              <span class="selected-item-body">
                [[_getLabel(item)]]
                <span class="readonly-separator" hidden$=[[!readonly]]>|</span>
                <paper-icon-button id="iconRemoveSelected"
                                   hidden$="[[disabled]]"
                                   icon="close"
                                   on-tap="_removeItem"></paper-icon-button>
              </span>
            </span>
          </template>

        </div>
      </div>

      <iron-icon icon="arrow-drop-down" slot="suffix"></iron-icon>

      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error aria-live="assertive" slot="add-on">[[errorMessage]]</paper-input-error>
      </template>

    </paper-input-container>

  </template>
  <script>
    'use strict';
    /**
     * @customElement
     * @polymer
     * @appliesMixin EsmmMixins.ListItemUtils
     */
    class EsmmSelectedOptions extends EsmmMixins.ListItemUtils(Polymer.GestureEventListeners(Polymer.Element)) {

      static get is() {
        return 'esmm-selected-options';
      }

      static get properties() {
        return {
          selectedItems: Array,
          label: String,
          noLabelFloat: Boolean,
          alwaysFloatLabel: Boolean,
          placeholder: String,
          autoValidate: Boolean,
          readonly: Boolean,
          disabled: Boolean,
          invalid: Boolean,
          errorMessage: String,
          _hidePlaceholder: Boolean
        };
      }

      /**
       * @param alwaysFloatLabel
       * @param placeholder
       * @returns {*}
       * @private
       */
      _computeAlwaysFloatLabel(alwaysFloatLabel,placeholder) {
        return alwaysFloatLabel || placeholder;
      }

      /**
       * Show or hide placeholder
       * @param e
       * @private
       */
      _selectedItemsDisplayHasChanged(e) {
        e.stopImmediatePropagation();
        // hide/show placeholder
        if (this.selectedItems instanceof Array && this.selectedItems.length > 0) {
          this.set('_hidePlaceholder', true);
        } else {
          this.set('_hidePlaceholder', false);
        }
      }

      /**
       * @event remove-selected-item
       * @param e
       * @private
       */
      _removeItem(e) {
        // fire remove event to parent
        this.dispatchEvent(new CustomEvent('remove-selected-item', {
          detail: e.model.item[this.optionValue],
          bubbles: true,
          composed: true
        }));
      }

    }

    window.customElements.define(EsmmSelectedOptions.is, EsmmSelectedOptions);
  </script>
</dom-module>
